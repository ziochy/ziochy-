<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Komentar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --accent-color: #6c5ce7;
            --text-color: #2d3436;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --hover-color: #a29bfe;
            --danger-color: #ff4d4d;
            --danger-hover-color: #e60000;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }

        .comment-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .comment-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }

        .comment-list {
            margin-bottom: 2rem;
        }

        .comment-item {
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 16px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .comment-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .comment-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 0.5rem;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
            object-fit: cover;
        }

        .comment-item p {
            margin: 0;
            font-size: 1rem;
            color: var(--text-color);
        }

        .comment-item small {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        .reply-info {
            display: block;
            font-size: 0.8rem;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .reply-info strong {
            font-weight: 600;
            color: var(--text-color);
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            margin-top: 0.5rem;
        }

        .btn-like, .btn-reply, .btn-delete {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .btn-like:hover, .btn-reply:hover, .btn-delete:hover {
            color: var(--hover-color);
            transform: translateY(-2px);
        }

        .btn-like.liked {
            color: var(--danger-color);
        }

        .btn-delete {
            color: var(--danger-color);
        }

        .btn-delete:hover {
            color: var(--danger-hover-color);
        }

        .replies {
            margin-left: 2rem;
            margin-top: 1rem;
            border-left: 2px solid var(--accent-color);
            padding-left: 1rem;
        }

        .comment-item.reply-comment {
            padding: 1rem;
            margin-left: 2rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .comment-item.reply-comment p {
            margin: 0;
            font-size: 0.9rem;
        }

        .comment-item.reply-comment small {
            font-size: 0.75rem;
        }

        .comment-item.reply-comment .comment-actions {
            margin-top: 0.3rem;
        }

        .comment-item.reply-comment .btn-like,
        .comment-item.reply-comment .btn-reply,
        .comment-item.reply-comment .btn-delete {
            font-size: 0.8rem;
        }

        #replyInfo {
            background: var(--bg-color);
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--accent-color);
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #replyInfo small {
            font-size: 0.9rem;
        }

        #replyInfo button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.3s ease;
        }

        #replyInfo button:hover {
            opacity: 0.8;
        }

        textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1rem;
        }

        textarea:focus {
            border-color: var(--hover-color);
            box-shadow: 0 0 8px rgba(108, 92, 231, 0.3);
            outline: none;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .comment-container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .comment-item.reply-comment {
                margin-left: 1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Notifikasi Pop-up */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-color);
            display: none;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
    </style>

</head>
<body>
    <!-- Notifikasi Pop-up -->
    <div id="notificationPopup" class="notification-popup">
        <span id="notificationMessage"></span>
    </div>

    <nav>
        <a href="javascript:history.back()" class="back-button">Kembali</a>
    </nav>

    <main class="comment-container">
        <h1 id="threadTitle">Komentar</h1>
        <div id="commentList" class="comment-list"></div>
        <form id="commentForm">
            <div id="replyInfo" style="display: none; margin-bottom: 10px;">
                <small>Balas <span id="replyToUsername"></span></small>
                <button type="button" onclick="cancelReply()" style="margin-left: 10px; background: none; border: none; color: var(--accent-color); cursor: pointer;">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
            <textarea id="commentContent" placeholder="Tulis komentar Anda..." required></textarea>
            <input type="hidden" id="parentId" value="">
            <button type="submit" class="btn">
                <i class="fas fa-paper-plane"></i> Kirim Komentar
            </button>
        </form>
    </main>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, where, doc, getDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { app } from '../firebase-config.js';

        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ambil ID thread dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const threadId = urlParams.get('threadId');

        // Fungsi untuk menampilkan notifikasi
        const showNotification = (message) => {
            const notificationPopup = document.getElementById('notificationPopup');
            const notificationMessage = document.getElementById('notificationMessage');
            notificationMessage.textContent = message;
            notificationPopup.style.display = 'block';
            setTimeout(() => {
                notificationPopup.style.display = 'none';
            }, 3000);
        };

        // Fungsi untuk mengambil data pengguna
        const getUserData = async (userId) => {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                return {
                    username: userDoc.data().username,
                    avatar: userDoc.data().avatar || 'assets/images/default-avatar.png'
                };
            }
            return { username: 'Anonim', avatar: 'assets/images/default-avatar.png' };
        };

        // Fungsi untuk memuat komentar
        const loadComments = async (parentId = '') => {
            const commentList = document.getElementById('commentList');
            const q = query(collection(db, 'comments'), where('threadId', '==', threadId), where('parentId', '==', parentId));
            const querySnapshot = await getDocs(q);

            for (const doc of querySnapshot.docs) {
                const comment = doc.data();
                const userData = await getUserData(comment.createdBy);
                const likesCount = comment.likes ? comment.likes.length : 0;
                const isLiked = comment.likes && comment.likes.includes(auth.currentUser.uid);

                const isReply = parentId !== '';

                commentList.innerHTML += `
                    <div class="comment-item ${isReply ? 'reply-comment' : ''}" id="comment-${doc.id}">
                        <div class="comment-header">
                            <img src="${userData.avatar}" alt="Avatar" class="comment-avatar">
                            <div>
                                <small>Oleh: ${userData.username}</small>
                                <p>${comment.content}</p>
                                ${isReply && comment.replyToUsername ? `
                                    <small class="reply-info">Balas <strong>${comment.replyToUsername}</strong></small>
                                ` : ''}
                            </div>
                        </div>
                        <div class="comment-actions">
                            <button onclick="toggleLike('${doc.id}')" class="btn-like ${isLiked ? 'liked' : ''}">
                                <i class="fas fa-thumbs-up"></i> ${likesCount}
                            </button>
                            <button onclick="replyToComment('${doc.id}', '${userData.username}')" class="btn-reply">
                                <i class="fas fa-reply"></i> Balas
                            </button>
                            ${comment.createdBy === auth.currentUser.uid ? `
                                <button onclick="deleteComment('${doc.id}')" class="btn-delete">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            ` : ''}
                        </div>
                        <div id="replies-${doc.id}" class="replies"></div>
                    </div>
                `;

                // Muat balasan komentar
                await loadComments(doc.id);
            }
        };

        // Fungsi untuk membalas komentar
        window.replyToComment = (parentId, username) => {
            document.getElementById('parentId').value = parentId;
            document.getElementById('replyToUsername').textContent = username;
            document.getElementById('replyInfo').style.display = 'block';
            document.getElementById('commentContent').focus();
        };

        // Fungsi untuk membatalkan balasan
        window.cancelReply = () => {
            document.getElementById('parentId').value = '';
            document.getElementById('replyToUsername').textContent = '';
            document.getElementById('replyInfo').style.display = 'none';
        };

        // Fungsi untuk mengirim komentar
        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('commentContent').value;
            const parentId = document.getElementById('parentId').value;
            const replyToUsername = document.getElementById('replyToUsername').textContent;

            if (content) {
                try {
                    const commentData = {
                        threadId: threadId,
                        parentId: parentId || '',
                        content: content,
                        createdAt: serverTimestamp(),
                        createdBy: auth.currentUser.uid,
                        likes: [],
                        replyToUsername: parentId ? replyToUsername : ''
                    };

                    await addDoc(collection(db, 'comments'), commentData);
                    showNotification(parentId ? `Anda membalas ${replyToUsername}` : 'Komentar berhasil dikirim');

                    // Reset form
                    document.getElementById('commentContent').value = '';
                    document.getElementById('parentId').value = '';
                    document.getElementById('replyToUsername').textContent = '';
                    document.getElementById('replyInfo').style.display = 'none';

                    // Muat ulang komentar
                    document.getElementById('commentList').innerHTML = '';
                    await loadComments();
                } catch (error) {
                    console.error('Error mengirim komentar:', error);
                    showNotification('Gagal mengirim komentar. Silakan coba lagi.');
                }
            }
        });

        // Fungsi untuk like/unlike komentar
        window.toggleLike = async (commentId) => {
            const commentRef = doc(db, 'comments', commentId);
            const commentDoc = await getDoc(commentRef);
            const likes = commentDoc.data().likes || [];

            if (likes.includes(auth.currentUser.uid)) {
                await updateDoc(commentRef, {
                    likes: arrayRemove(auth.currentUser.uid)
                });
            } else {
                await updateDoc(commentRef, {
                    likes: arrayUnion(auth.currentUser.uid)
                });
            }

            // Muat ulang komentar
            document.getElementById('commentList').innerHTML = '';
            await loadComments();
        };

        // Fungsi untuk menghapus komentar
        window.deleteComment = async (commentId) => {
            if (confirm('Apakah Anda yakin ingin menghapus komentar ini?')) {
                await deleteDoc(doc(db, 'comments', commentId));
                document.getElementById('commentList').innerHTML = '';
                await loadComments();
            }
        };

        // Muat komentar saat halaman dimuat
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadComments();
            } else {
                window.location.href = 'login.html'; // Redirect jika belum login
            }
        });
    </script>
</body>
</html>